/*
 * Copyright (C) 2009-2016 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.scfld.md.controller.ScfldMasterController");jQuery.sap.require("publicservices.her.mycourses.s1.utils.Formatter");jQuery.sap.require("sap.ushell.services.URLParsing");sap.ca.scfld.md.controller.ScfldMasterController.extend("publicservices.her.mycourses.s1.view.S2",{onInit:function(){var T="";var C='';var p='';this.oNavFilter=null;this.acadYear=null;this.acadSess=null;this.filterByYearAndSession=null;this.aFilterItems=this.getFilterItems();if(sap.ushell.Container){var o=this.oApplicationFacade.oApplicationImplementation.getComponent();var s=o.getComponentData().startupParameters;if(s){if(s.TileType&&s.TileType.length>0){T=s.TileType[0].split("'")[1];if(T===undefined){T=s.TileType[0];}}if(s.CourseId&&s.CourseId.length>0){C=s.CourseId[0];}if(s.ProgramStudyId&&s.ProgramStudyId.length>0){p=s.ProgramStudyId[0];}var P='';var A='';var d='';if(s.ProgType&&s.ProgType.length>0){P=s.ProgType[0];}if(s.AcademicYear&&s.AcademicYear.length>0){A=s.AcademicYear[0];}if(s.AcademicSession&&s.AcademicSession.length>0){d=s.AcademicSession[0];}var f=new sap.ui.model.Filter('CourseId','EQ',C);var F=new sap.ui.model.Filter('ProgramStudyId','EQ',p);var e=new sap.ui.model.Filter('ProgType','EQ',P);var g=new sap.ui.model.Filter('AcademicYear','EQ',A);var h=new sap.ui.model.Filter('AcademicSession','EQ',d);this.oNavFilter=new sap.ui.model.Filter([f,F,e,g,h],true);}}switch(T){case'Waitlist':this.filterBy="WAITING_LIST";break;case'Register':this.filterBy="KEY_REGISTERED";break;case'Wishlist':this.filterBy="WISH_LIST";break;case'All':this.filterBy="KEY_ALL";break;case'NAV':this.filterBy="NAV";break;case'SPEC':this.filterBy="KEY_SPEC";break;default:this.filterBy="KEY_ALL";break;}this.groupBy='grp_by_module';this.aGroupBySorter=[];this.aFilter=[];this.createGroupBySorter();this.createFilters();this.oList=this.byId('list');this.oListItem=this.byId('MAIN_LIST_ITEM').clone();this.searchFilters=null;var U=sap.ushell.Container.getService("URLParsing");if(U.getHash(location.href)<0&&this.filterBy==="KEY_ALL"){this.oApplicationFacade.oDtlsJSONModel=new sap.ui.model.json.JSONModel();this.oApplicationFacade.oDtlsInitLoad=true;var i;if(this.oNavFilter!=null){i=new sap.ui.model.Filter([this.aFilter[this.filterBy],this.oNavFilter],true);}else{i=this.aFilter[this.filterBy];}var m=this.getView().getModel();m.read("/CourseDetailSet",{async:true,urlParameters:{"$top":1,"$skip":0,"$expand":"EventDetails,EligibilityDetails,CoRequistesDetails"},sorters:[this.aGroupBySorter[this.groupBy]],success:jQuery.proxy(function(r,a){var b=r.results[0];var c=b.CoRequistesDetails.results;var E=b.EventDetails.results;var j=b.EligibilityDetails.results;b.CoRequistesDetails=c;b.EventDetails=E;b.EligibilityDetails=j;this.oApplicationFacade.oDtlsJSONModel.setData({result:b});if(this.oApplicationFacade.oApplicationImplementation.oSplitContainer.getDetailPages().length>0){var D=this.oApplicationFacade.oApplicationImplementation.oSplitContainer.getDetailPages()[0];var k=this.oApplicationFacade.oDtlsJSONModel.getProperty("/result/CoReqIndicator");var l=this.oApplicationFacade.oDtlsJSONModel.getProperty("/result/EligibilityIndicator");D.getController().setDetailPageConfig.call(D.getController(),k,l);this.getSplitContainer().getCurrentDetailPage().getController().getActionButton(false);this.oApplicationFacade.oDtlsInitLoad=false;}},this),error:function(a,b){}});}this.ListBinding();this.oContMaster=this;this.oList.attachUpdateFinished(function(a,b,c){this.oApplicationFacade.oApplicationImplementation.oMHFHelper.defineMasterHeaderFooter(this);var B=a.getSource().getSelectedContexts()[0];if(B!=undefined&&this.getSplitContainer().getCurrentDetailPage()){if(this.getSplitContainer().getCurrentDetailPage().getModel()instanceof sap.ui.model.odata.ODataModel)this.getSplitContainer().getCurrentDetailPage().getController().getActionButton(false);}else if(B==undefined&&this.getSplitContainer().getCurrentDetailPage()&&!sap.ui.Device.system.phone){if(this.getSplitContainer().getCurrentDetailPage().getModel()instanceof sap.ui.model.odata.ODataModel&&this.getSplitContainer().getCurrentDetailPage().getController().getActionButton){this.getSplitContainer().getCurrentDetailPage().getController().getActionButton(true);}}},this);this.onFilterSelected(this.filterBy);},ListBinding:function(){var f=null;if(this.oNavFilter!=null){f=new sap.ui.model.Filter([this.aFilter[this.filterBy],this.oNavFilter],true);}else{f=this.aFilter[this.filterBy];}if(this.searchFilters!=null){var F=new sap.ui.model.Filter([this.searchFilters,f],true);this.oList.bindAggregation("items",{path:'/CourseListSet',template:this.oListItem,sorter:this.aGroupBySorter[this.groupBy],filters:F});}else{this.oList.bindAggregation("items",{path:'/CourseListSet',template:this.oListItem,sorter:this.aGroupBySorter[this.groupBy],filters:f});}this.registerMasterListBind(this.oList);},createGroupBySorter:function(){var b=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle();this.oSorterPrgOfStdy=new sap.ui.model.Sorter("ProgramStudyId",false,function(c){var p=c.getProperty('ProgOfStudyTxt');var P=c.getProperty('ProgramStudyId');if(p!==""){return{key:P+"_start",text:p};}else{return{key:P,text:b.getText('OTHERS')};}});this.aGroupBySorter['grp_by_prog_study']=[this.oSorterPrgOfStdy];this.oSorterModule=new sap.ui.model.Sorter("ModuleGroupId",false,function(c){var m=c.getProperty("ModuleGroupId");var M=c.getProperty("ModuleGrpTxt");if(M!==''){return{key:m,text:M};}else{return{key:m,text:b.getText('OTHERS')};}});this.aGroupBySorter['grp_by_module']=[this.oSorterModule];this.oSorterPrgType=new sap.ui.model.Sorter("ProgType",false,function(c){var p=c.getProperty("ProgType");var P=c.getProperty("ProgTypet");if(P!==''){return{key:p,text:P};}else{return{key:p,text:b.getText('OTHERS')};}});this.aGroupBySorter['grp_by_prog_Type']=[this.oSorterPrgType];},getFilterItems:function(){var b=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle();var f=[{text:b.getText('OPEN_FOR_FILTER'),key:"KEY_ALL"},{text:b.getText('STUDY_PLAN'),key:"STUDY_PLAN"},{text:b.getText('REGISTERED'),key:"KEY_REGISTERED"},{text:b.getText('WAITING_LIST'),key:"WAITING_LIST"},{text:b.getText('WISH_LIST'),key:"WISH_LIST"},{text:b.getText('ADVISOR_LIST'),key:"ADVISOR_LIST"},{text:b.getText('SPECIALIZATION'),key:"KEY_SPEC"}];return f;},createFilters:function(){var f=new sap.ui.model.Filter('ListInd','EQ','REG');this.aFilter['KEY_REGISTERED']=f;var F=new sap.ui.model.Filter('ListInd','EQ','WAIT');this.aFilter['WAITING_LIST']=F;var o=new sap.ui.model.Filter('ListInd','EQ','NAV');this.aFilter['NAV']=o;var a=new sap.ui.model.Filter('ListInd','EQ','WISH');this.aFilter['WISH_LIST']=a;var b=new sap.ui.model.Filter('ListInd','EQ','ALL');this.aFilter['KEY_ALL']=b;var c=new sap.ui.model.Filter('ListInd','EQ','SPLN');this.aFilter['STUDY_PLAN']=c;var d=new sap.ui.model.Filter('ListInd','EQ','ADV');this.aFilter['ADVISOR_LIST']=d;var e=new sap.ui.model.Filter('ListInd','EQ','SPEC');this.aFilter['KEY_SPEC']=e;},isBackendSearch:function(){return true;},applyBackendSearchPattern:function(f,b){var s=f.toLowerCase();var F=null;var o=this.aFilter[this.filterBy];var a=null;var c=null;if(this.acadYear!==""||this.acadYear!==null){a=new sap.ui.model.Filter('AcademicYear','EQ',this.acadYear);}if(this.acadSess!==""||this.acadSess!==null){c=new sap.ui.model.Filter('AcademicSession','EQ',this.acadSess);}if(s&&s!==""){var d=new sap.ui.model.Filter('CourseText',sap.ui.model.FilterOperator.Contains,s);this.searchFilters=new sap.ui.model.Filter([d],true);if(o)F=new sap.ui.model.Filter([o,this.searchFilters,c,a],true);else{F=new sap.ui.model.Filter([this.searchFilters,c,a],true);}}else{this.searchFilters=null;if(o){F=new sap.ui.model.Filter([o,c,a],true);}}b.aApplicationFilters=[];b.filter(F);},getList:function(){return this.byId("list");},_handleGroupingChanged:function(k){if(k===this.groupBy){return;}else{this.groupBy=k;var l=this.getList();var b=l.getBinding("items");b.sort(this.aGroupBySorter[this.groupBy]);}},handleFilterChanged:function(k,a,b){if(k===this.filterBy&&this.acadYear==a&&this.acadSess==b){return;}else{this.filterBy=k;this.onFilterSelected(k);var l=this.getList();var B=l.getBinding("items");B.aApplicationFilters=[];var f=[];if(this.searchFilters!=null){var F=new sap.ui.model.Filter([this.aFilter[this.filterBy],this.searchFilters],true);f.push(F);}else{var F=this.aFilter[this.filterBy];f.push(F);}if(a||b){var o=new sap.ui.model.Filter('AcademicYear','EQ',a);f.push(o);var c=new sap.ui.model.Filter('AcademicSession','EQ',b);f.push(c);}this.acadYear=a;this.acadSess=b;B.filter(f);}},navBackOnError:function(){window.history.go(-1);},onFilterSelected:function(F){var b=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle();var t=this.getList();var i=t.getInfoToolbar();var I=this.byId('ListInfoTool');var o=this.byId('ListInfoToolIcon');var f=this.aFilterItems;if(F=='KEY_ALL'){I.setText(b.getText('FILTERED_BY',[f[0].text]));}else if(F=='NAV'){i.setVisible(false);}else{i.setVisible(true);var a=[];a['KEY_REGISTERED']="sap-icon://course-book";a['WAITING_LIST']="sap-icon://time-entry-request";a['ADVISOR_LIST']="";a['WISH_LIST']="sap-icon://favorite-list";a['KEY_ALL']="";$.each(f,function(k,v){if(F==v.key){I.setText(b.getText('FILTERED_BY',[v.text]));o.setSrc(a[v.key]);}});}},applyFilterFromContext:function(h){var c=this.oApplicationFacade.oApplicationImplementation.getComponent().getId();sap.ui.getCore().getEventBus().publish(c,'deepLinking',{path:h});if(this.getSplitContainer().getCurrentDetailPage()){this.getSplitContainer().getCurrentDetailPage().getController().getActionButton(true,true);}},getHeaderFooterOptions:function(m){var t=this;var b=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle();var g=[];var m=this.oModSetting;if(this.oList.getSelectedItem()){m=this.oList.getSelectedItem().getBindingContext().getObject().ModuleSetting;this.oModSetting=m;}if(m=='XX'){g=[{text:b.getText('GRP_PROG_STUDY'),key:"grp_by_prog_study"},{text:b.getText('GRP_MODULE'),key:"grp_by_module"},{text:b.getText('GRP_PROG_TYPE'),key:"grp_by_prog_Type"}];}else if(m=='SC'){g=[{text:b.getText('GRP_PROG_STUDY'),key:"grp_by_prog_study"},{text:b.getText('GRP_MODULE'),key:"grp_by_module"}];}else if(m=='PT'){g=[{text:b.getText('GRP_MODULE'),key:"grp_by_module"},{text:b.getText('GRP_PROG_TYPE'),key:"grp_by_prog_Type"}];}else if(m==null){g=[{text:b.getText('GRP_PROG_STUDY'),key:"grp_by_prog_study"},{text:b.getText('GRP_MODULE'),key:"grp_by_module"},{text:b.getText('GRP_PROG_TYPE'),key:"grp_by_prog_Type"}];}return{sI18NMasterTitle:"MASTER_TITLE",oGroupOptions:{aGroupItems:g,sSelectedItemKey:t.groupBy,onGroupSelected:function(k){t.getHeaderFooterOptions().oFilterOptions.sSelectedItemKey=k;t._handleGroupingChanged(k);t.oApplicationFacade.oApplicationImplementation.oMHFHelper.setHeaderFooter(t.getHeaderFooterOptions());}},oFilterOptions:{sBtnTxt:"",bDisabled:false,onFilterPressed:jQuery.proxy(function(e){t.handleOpenDialog(e);},this)},aAdditionalSettingButtons:{}};},handleOpenDialog:function(e){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("publicservices.her.mycourses.s1.template.FilterDialog",this);}this._oDialog._updateFilterCounters=function(){};this._oDialog.setModel(this.oApplicationFacade.oApplicationImplementation.AppI18nModel,'i18n');this._oDialog.setModel(this.getView().getModel());jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oDialog);this._oDialog.open();var f=0;switch(this.filterBy){case"KEY_ALL":f=0;break;case"STUDY_PLAN":f=1;break;case"KEY_REGISTERED":f=2;break;case"WAITING_LIST":f=3;break;case"WISH_LIST":f=4;break;case"ADVISOR_LIST":f=5;break;case"KEY_SPEC":f=6;break;}this._oDialog.getFilterItems()[0].getItems()[f].setSelected(true);var t=this;window.setTimeout(function(){if(t._oDialog.getFilterItems()[1].getItems()){t._oDialog.getFilterItems()[1].getItems()[0].setSelected(true);}},1000);},handleConfirm:function(e){var a="";var b="";var c="";var d="";if(e.getSource().getSelectedFilterItems()[0]){if(e.getSource().getSelectedFilterItems()[0].getKey()==""){a=e.getSource().getSelectedFilterItems()[0].getBindingContext().getObject().AcademicYear;c=e.getSource().getSelectedFilterItems()[0].getBindingContext().getObject().AcademicYearText;b=e.getSource().getSelectedFilterItems()[0].getBindingContext().getObject().AcademicSession;d=e.getSource().getSelectedFilterItems()[0].getBindingContext().getObject().AcademicSessText;this.filterByYearAndSession=c+" "+d;this.handleFilterChanged(this.filterBy,a,b,c,d);}else{var s=e.getSource().getSelectedFilterItems()[0].getKey();if(e.getSource().getSelectedFilterItems()[1]){a=e.getSource().getSelectedFilterItems()[1].getBindingContext().getObject().AcademicYear;c=e.getSource().getSelectedFilterItems()[1].getBindingContext().getObject().AcademicYearText;b=e.getSource().getSelectedFilterItems()[1].getBindingContext().getObject().AcademicSession;d=e.getSource().getSelectedFilterItems()[1].getBindingContext().getObject().AcademicSessText;}else{a=null;b=null;c=null;d=null;}this.filterByYearAndSession=c+" "+d;this.handleFilterChanged(s,a,b,c,d);}}},handleCancel:function(e){if(this._oDialog.getFilterItems()[1].getItems()){var a=this._oDialog.getFilterItems()[1].getItems();for(var i=0,b=0;i<a.length;i++){if(this._oDialog.getFilterItems()[1].getItems()[i].getText()==this.filterByYearAndSession){b=i;}}this._oDialog.getFilterItems()[1].getItems()[b].setSelected(true);}},onExit:function(){if(this._oDialog){this._oDialog.destroy();}},onListerFiltering:function(){var l=this.getList();var b=l.getBinding("items");b.aApplicationFilters=[];var f=[];if(this.searchFilters!=null){var F=new sap.ui.model.Filter([this.aFilter[this.filterBy],this.searchFilters],true);f.push(F);}else{var F=this.aFilter[this.filterBy];f.push(F);}if(this.acadYear||this.acadSess){var o=new sap.ui.model.Filter('AcademicYear','EQ',this.acadYear);f.push(o);var a=new sap.ui.model.Filter('AcademicSession','EQ',this.acadSess);f.push(a);}b.filter(f);}});
